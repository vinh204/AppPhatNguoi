rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function để kiểm tra user đang đăng nhập
    // Lưu ý: Ứng dụng hiện tại không sử dụng Firebase Authentication
    // Nên rules này sẽ có giới hạn. Nên migrate sang Firebase Authentication để bảo mật tốt hơn
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function để kiểm tra user có phải owner không
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function để validate phoneNumber format
    function isValidPhoneNumber(phone) {
      return phone is string && 
             phone.matches('^0[0-9]{9,10}$');
    }
    
    // Helper function để validate bienSo format (biển số Việt Nam)
    function isValidBienSo(bienSo) {
      return bienSo is string && 
             bienSo.size() > 0 && 
             bienSo.size() <= 20;
    }
    
    // ============================================================
    // USERS COLLECTION
    // ============================================================
    // Lưu ý: Vì ứng dụng không dùng Firebase Auth, 
    // rules này chỉ bảo vệ ở mức cơ bản
    // Nên migrate sang Firebase Authentication để bảo mật tốt hơn
    match /users/{userId} {
      // CẢI THIỆN: Chỉ cho phép đọc user của chính mình
      // Kiểm tra userId phải khớp với phoneNumber trong document
      // Và chỉ cho phép đọc nếu isLoggedIn = true (tức là user đang đăng nhập)
      allow read: if isValidPhoneNumber(userId) &&
                     resource.data.phoneNumber == userId &&
                     (resource.data.isLoggedIn == true || 
                      // Cho phép đọc để kiểm tra phone exists (nhưng không trả về password)
                      request.query.limit <= 1);
      
      // Chỉ cho phép tạo user mới với phoneNumber hợp lệ
      // Kiểm tra password phải là BCrypt hash (bắt đầu bằng $2a$, $2b$, hoặc $2y$)
      allow create: if isValidPhoneNumber(request.resource.data.phoneNumber) &&
                       request.resource.data.phoneNumber == userId &&
                       request.resource.data.keys().hasAll(['phoneNumber', 'password', 'isLoggedIn', 'createdAt']) &&
                       request.resource.data.password is string &&
                       request.resource.data.password.matches('^\\$2[aby]\\$.*') && // BCrypt hash format
                       request.resource.data.isLoggedIn is bool &&
                       request.resource.data.createdAt is timestamp &&
                       // Không cho phép tạo user nếu đã tồn tại
                       !exists(/databases/$(database)/documents/users/$(userId));
      
      // Chỉ cho phép update user của chính mình
      // Kiểm tra phoneNumber không được thay đổi
      // Nếu update password, phải là BCrypt hash
      allow update: if isValidPhoneNumber(userId) &&
                       request.resource.data.phoneNumber == userId &&
                       resource.data.phoneNumber == userId && // Phone number không được thay đổi
                        (!('password' in request.resource.data) || 
                        (request.resource.data.password is string &&
                         request.resource.data.password.matches('^\\$2[aby]\\$.*'))) && // BCrypt hash format
                        (!('isLoggedIn' in request.resource.data) || 
                        request.resource.data.isLoggedIn is bool) &&
                       // Phải có updatedAt khi update
                       ('updatedAt' in request.resource.data) &&
                       request.resource.data.updatedAt is timestamp;
      
      // Không cho phép xóa user
      allow delete: if false;
    }
    
    // ============================================================
    // HISTORY COLLECTION
    // ============================================================
    match /history/{historyId} {
      // CẢI THIỆN: Chỉ cho phép đọc lịch sử của chính mình
      // Kiểm tra userId trong document phải hợp lệ
      allow read: if isValidPhoneNumber(resource.data.userId) &&
                     resource.data.userId is string;
      
      // Chỉ cho phép tạo lịch sử với dữ liệu hợp lệ
      allow create: if request.resource.data.keys().hasAll(['userId', 'bienSo', 'loaiXe', 'thoiGian', 'coViPham']) &&
                       isValidPhoneNumber(request.resource.data.userId) &&
                       isValidBienSo(request.resource.data.bienSo) &&
                       request.resource.data.loaiXe is string &&
                       request.resource.data.thoiGian is timestamp &&
                       request.resource.data.coViPham is bool &&
                       (!('soLoi' in request.resource.data) || 
                        request.resource.data.soLoi is int);
      
      // Chỉ cho phép update lịch sử của chính mình
      // Lưu ý: Vì không dùng Firebase Auth, rule này không thể enforce chặt chẽ
      allow update: if resource.data.userId == request.resource.data.userId &&
                       isValidBienSo(request.resource.data.bienSo) &&
                       request.resource.data.loaiXe is string &&
                       request.resource.data.coViPham is bool;
      
      // Chỉ cho phép xóa lịch sử của chính mình
      // Kiểm tra userId phải khớp
      allow delete: if isValidPhoneNumber(resource.data.userId) &&
                       resource.data.userId is string;
    }
    
    // ============================================================
    // AUTO_CHECK COLLECTION
    // ============================================================
    match /auto_check/{autoCheckId} {
      // CẢI THIỆN: Chỉ cho phép đọc auto check của chính mình
      // Kiểm tra userId trong document phải hợp lệ
      allow read: if isValidPhoneNumber(resource.data.userId) &&
                     resource.data.userId is string;
      
      // Chỉ cho phép tạo auto check với dữ liệu hợp lệ
      allow create: if request.resource.data.keys().hasAll(['userId', 'bienSo', 'loaiXe', 'enabled']) &&
                       isValidPhoneNumber(request.resource.data.userId) &&
                       isValidBienSo(request.resource.data.bienSo) &&
                       request.resource.data.loaiXe is int &&
                       request.resource.data.loaiXe >= 1 &&
                       request.resource.data.loaiXe <= 3 &&
                       request.resource.data.enabled is bool;
      
      // Chỉ cho phép update auto check của chính mình
      // Lưu ý: Vì không dùng Firebase Auth, rule này không thể enforce chặt chẽ
      allow update: if resource.data.userId == request.resource.data.userId &&
                       isValidBienSo(request.resource.data.bienSo) &&
                       request.resource.data.loaiXe is int &&
                       request.resource.data.loaiXe >= 1 &&
                       request.resource.data.loaiXe <= 3 &&
                       request.resource.data.enabled is bool;
      
      // Chỉ cho phép xóa auto check của chính mình
      // Kiểm tra userId phải khớp
      allow delete: if isValidPhoneNumber(resource.data.userId) &&
                       resource.data.userId is string;
    }
    
    // ============================================================
    // SECURITY AUDIT LOGS COLLECTION
    // ============================================================
    // Chỉ cho phép ghi log, không cho phép đọc/xóa từ client
    match /security_audit_logs/{logId} {
      allow create: if request.resource.data.keys().hasAll(['eventType', 'phoneNumber', 'details', 'severity', 'timestamp']) &&
                       request.resource.data.eventType is string &&
                       request.resource.data.phoneNumber is string &&
                       request.resource.data.details is string &&
                       request.resource.data.severity is string &&
                       request.resource.data.timestamp is timestamp;
      allow read: if false; // Không cho phép đọc từ client
      allow update: if false; // Không cho phép update
      allow delete: if false; // Không cho phép xóa
    }
    
    // ============================================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

